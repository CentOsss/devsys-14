# tcpdump -n -e -ttt -i pflog0
# pfctl -f /etc/pf.conf

# Variable declaration
ext_if_1 = "vlan150"
ext_if_2 = "vlan4"
dmz_if = "vlan3"
int_if_1 = "em1"
int_if_2 = "vlan2"
int_if_3 = "vlan900"
int_if_4 = "vlan66"

table <lan_work> {172.16.0.0/16, 172.17.0.0/16, 192.168.2.0/24, 192.168.3.0/24, 192.168.253.0/24, !172.16.0.52, !172.16.0.1, !172.16.0.5, !172.16.0.8, !172.16.13.1, !172.16.13.2, !172.16.13.5, !172.16.13.6, !172.16.13.46, !172.16.13.54, !172.16.13.63, !172.16.13.71, 172.16.13.74, !172.16.13.80, !172.16.13.253, !172.16.0.3, !172.16.25.0/24, !172.20.0.0/16, !172.16.13.0/24, !172.16.0.23, !172.16.15.0/24, !172.16.13.17, !172.16.15.59, !172.16.13.107, !172.16.0.24, !172.16.23.174, !172.16.23.173, !172.16.23.175, !172.16.23.176, 172.16.23.0/24, !172.16.13.113, !172.16.13.128, !172.16.13.129, !172.16.13.120, !172.16.0.200}

table <domino>   {172.16.0.0/16, !172.16.0.2, !172.16.0.8, !172.16.0.9, !172.16.0.16, !172.16.13.1, !172.16.13.46, !172.17.10.71, !172.17.10.72, !172.17.10.73}

int_network_1="172.16.0.0/16"

table <no_squid_host> {93.153.243.178, 172.16.13.3, 192.168.5.0/24, 192.168.100.0/24, 172.16.13.54, 172.17.13.50, 172.17.13.51, 172.17.21.89, 172.16.17.21, 172.16.0.4}

hackers="77.95.225.11"

udp_out = "domain, 87, 123, 33333"

tcp_out = "ssh, http, https, 110, 123, pop3s, pptp, 143, 465, 873, 993, 1366, 1935, 1959, 1961, 1966, 1984, 2041, 2042, 3389, 5190, 5222, 8000, 9080, 9418, 9443, 11024, 33333, 44444, 50022, 50025, 50110, 51020"

icmp_types = "echoreq"

priv_nets = "{ 127.0.0.0/8, 192.168.0.0/24, 172.16.0.0/16, 10.0.0.0/8 }"

wotu="32801:32825, 20014"
wott="3128,8081,8088,53,80,8080,20000:25000,32801,32803,443"

# Pf variable

set loginterface $ext_if_1
set block-policy drop
set limit src-nodes 1000000
set limit states 1000000
set limit frags 100000
set optimization normal

# Ftp-proxy anchor
anchor "ftp-proxy/*"

# Redirect to FTP proxy
pass in quick on {$int_if_1,$int_if_2} inet proto tcp to port ftp divert-to 127.0.0.1 port 8021

pass out quick on $ext_if_1 proto {tcp,udp,gre} from 172.16.0.0/16 to any nat-to 89.223.65.148

# Redirect to HTTP proxy
pass in quick on {$int_if_1,$int_if_2} proto tcp from {<lan_work>} to {!<no_squid_host>} port 80 rdr-to 172.16.0.1 port 3128

#pass in quick on {$int_if_1,$int_if_2} proto tcp from {<lan_work>} to {!$no_squid_host} port 443 rdr-to 172.16.0.1 port 3128
#pass in quick on {$int_if_1,$int_if_2} proto tcp from {<lan_work>} to any port 80 rdr-to 172.16.0.1 port 3128

# Argos
pass out quick on $ext_if_1 proto {tcp,udp} from {<lan_work>} to {212.119.184.142,80.247.184.198,80.247.184.204,80.247.184.200} port {25,110} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto {tcp,udp} from {<lan_work>} to {212.119.162.89,80.247.184.202} port {80} nat-to 89.223.65.148

# Sberbank
pass out quick on $ext_if_1 proto {tcp,udp,gre} from $int_if_1:network to {84.204.56.210,84.204.56.212,84.204.56.213,84.204.34.245} nat-to 89.223.65.148

# S.b. terminals
pass out quick on $ext_if_1 proto {tcp,udp,gre} from $int_if_1:network to {81.3.135.249} nat-to 89.223.65.148

pass out quick on $ext_if_1 proto {tcp,udp,gre} from 192.168.0.0/16 to {81.3.135.249} nat-to 89.223.65.148

pass out quick on $ext_if_1 proto {tcp,udp,gre} from 172.16.13.5 to any nat-to 89.223.65.147
pass out quick on $ext_if_1 proto {tcp,udp,gre} from 172.16.13.237 to any nat-to 89.223.65.147
pass out quick on $ext_if_1 proto {tcp,udp,gre} from 172.16.22.73 to any nat-to 89.223.65.147
pass out quick on $ext_if_1 proto {tcp,udp,gre} from 172.16.22.160 to any nat-to 89.223.65.147
# Rayffazen
pass out quick on $ext_if_1 proto {tcp,udp} from $int_network_1 to {217.148.214.210} port {25,110} nat-to 89.223.65.148

# VTB
pass out quick on $ext_if_1 proto {tcp,udp} from {<lan_work>} to {81.3.179.6} port { 25,110,1024 } nat-to 89.223.65.148

# Commita
pass out quick on $ext_if_1 proto {tcp,udp,gre} from {<lan_work>} to {213.182.169.11} nat-to 89.223.65.148

# Commita Courier
pass out quick on $ext_if_1 proto {tcp,udp,gre} from {<lan_work>} to {213.182.169.93} nat-to 89.223.65.148

# PFR
pass out quick on $ext_if_1 proto {tcp,udp} from $int_if_1:network to {213.182.169.32} port {40226} nat-to 89.223.65.148

# Tensor
pass out quick on $ext_if_1 proto {tcp} from {<lan_work>} to {91.213.144.130} port {25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto {tcp} from {<lan_work>} to {91.213.144.131} port {110} nat-to 89.223.65.148

# Nat
pass out quick on $ext_if_1 proto tcp from 172.16.13.0/24 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto tcp from 172.16.15.0/24 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_2 proto tcp from 172.16.13.0/24 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_2 proto tcp from 172.16.15.0/24 to any port {!=25} nat-to 62.152.70.188


pass out quick on $ext_if_1 proto tcp from 172.20.0.0/16 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.20.0.0/16 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_2 proto tcp from 172.20.0.0/16 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_2 proto udp from 172.20.0.0/16 to any port {!=25} nat-to 62.152.70.188

pass out quick on $ext_if_1 proto tcp from 172.18.0.0/16 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.18.0.0/16 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto gre from 172.18.0.0/16 to any nat-to 89.223.65.148
pass out quick on $ext_if_1 proto icmp from 172.18.0.0/16 to any nat-to 89.223.65.148


pass out quick on $ext_if_1 proto tcp from 172.16.0.2 to any nat-to 89.223.65.148
pass out quick on $ext_if_1 proto gre from 172.16.0.2 to any nat-to 89.223.65.148

pass out quick on $ext_if_2 proto tcp from 172.16.0.2 to any nat-to 89.223.65.148
pass out quick on $ext_if_2 proto gre from 172.16.0.2 to any nat-to 89.223.65.148


pass out quick on $ext_if_1 proto tcp from 172.16.0.3 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.0.3 to any port {!=25} nat-to 89.223.65.148

pass out quick on $ext_if_1 proto tcp from 172.16.0.5 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.0.5 to any port {!=25} nat-to 89.223.65.148

pass out quick on $ext_if_1 proto tcp from 172.16.0.36 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.0.36 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_2 proto tcp from 172.16.0.36 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_2 proto udp from 172.16.0.36 to any port {!=25} nat-to 62.152.70.188

pass out quick on $ext_if_1 proto tcp from 172.16.13.1 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.13.1 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto icmp from 172.16.13.1 to any  nat-to 89.223.65.148
pass out quick on $ext_if_1 proto gre from 172.16.13.1 to any  nat-to 89.223.65.148

pass out quick on $ext_if_1 proto tcp from 172.16.13.46 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.13.46 to any port {!=25} nat-to 89.223.65.148

pass out quick on $ext_if_1 proto tcp from 172.16.13.71 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.13.71 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto icmp from 172.16.13.71 to any  nat-to 89.223.65.148
pass out quick on $ext_if_1 proto gre from 172.16.13.71 to any  nat-to 89.223.65.148

pass out quick on $ext_if_1 proto tcp from 172.16.0.8 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.0.8 to any port {!=25} nat-to 89.223.65.148

pass out quick on $ext_if_1 proto tcp from 172.16.15.17 to any port {27014:27050} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.15.17 to any port {27000:27030} nat-to 89.223.65.148

pass out quick on $ext_if_1 proto tcp from 172.16.15.27 to any nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.15.27 to any nat-to 89.223.65.148

pass out quick on $ext_if_1 proto tcp from 172.16.13.2 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.13.2 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto icmp from 172.16.13.2 to any nat-to 89.223.65.148

pass out quick on $ext_if_1 proto tcp from 172.16.13.74 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.13.74 to any port {!=25} nat-to 89.223.65.148

pass out quick on $ext_if_1 proto tcp from 172.16.13.45 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.13.45 to any port {!=25} nat-to 89.223.65.148

pass out quick on $ext_if_1 proto tcp from 172.16.13.5 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.13.5 to any port {!=25} nat-to 89.223.65.148

pass out quick on $ext_if_1 proto tcp from 172.16.13.6 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.13.6 to any port {!=25} nat-to 89.223.65.148

#pass out quick on $ext_if_1 proto udp from 172.16.13.8 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.13.46 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.13.57 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto tcp from 172.16.13.57 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.13.58 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto tcp from 172.16.13.58 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.13.60 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto tcp from 172.16.13.60 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.13.61 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto tcp from 172.16.13.61 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.13.67 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto tcp from 172.16.13.67 to any port {!=25} nat-to 89.223.65.148

pass out quick on $ext_if_1 proto udp from 172.16.13.71 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto tcp from 172.16.13.71 to any port {!=25} nat-to 89.223.65.148

pass out quick on $ext_if_1 proto udp from 172.16.13.111 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto tcp from 172.16.13.111 to any port {!=25} nat-to 89.223.65.148

#temporary for mac SA
pass out quick on $ext_if_1 proto udp from 172.16.13.112 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto tcp from 172.16.13.112 to any port {!=25} nat-to 89.223.65.148


pass out quick on $ext_if_1 proto udp from 172.16.15.12 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto tcp from 172.16.15.12 to any port {!=25} nat-to 89.223.65.148

pass out quick on $ext_if_1 proto udp from 172.16.15.60 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto tcp from 172.16.15.60 to any port {!=25} nat-to 89.223.65.148


pass out quick on $ext_if_1 proto tcp from 172.16.13.253 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.13.253 to any port {!=25} nat-to 89.223.65.148

pass out quick on $ext_if_1 proto tcp from 172.16.13.248 to any nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.13.248 to any nat-to 89.223.65.148

#pass out quick on $ext_if_1 proto tcp from 172.16.25.0/24 to any nat-to 89.223.65.148
#pass out quick on $ext_if_1 proto udp from 172.16.25.0/24 to any nat-to 89.223.65.148


#ohrana
pass out quick on $ext_if_1 proto udp from 172.16.13.63 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto tcp from 172.16.13.63 to any port {!=25} nat-to 89.223.65.148
#
pass out quick on $ext_if_1 proto tcp from 172.16.15.71 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto tcp from 172.17.0.0/16 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto tcp from 172.16.0.30 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto tcp from 172.16.0.55 to any port {!=25} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto tcp from {<lan_work>} to any port {$tcp_out} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from {<lan_work>} to any port {$udp_out} nat-to 89.223.65.148

pass out quick on $ext_if_1 proto tcp from 172.16.15.27 to any port {$wott} nat-to 89.223.65.148
pass out quick on $ext_if_1 proto udp from 172.16.15.27 to any port {$wotu} nat-to 89.223.65.148

#Vlan66-to-lan block
block in quick on $int_if_4 proto {tcp,udp,icmp} from {<domino>} to any
block out quick on $int_if_4 proto {tcp,udp,icmp} from {<domino>} to any

block in quick on {$ext_if_1, $ext_if_2} inet proto tcp from {$hackers} to any

# Redirect to intranet
pass in quick on $ext_if_1 proto {tcp,udp} to 89.223.65.148 port 2222 rdr-to 172.16.10.150 port 443
pass in quick on $ext_if_2 proto {tcp,udp} to 62.152.70.180 port 2222 rdr-to 172.16.10.150 port 443
pass in quick on $ext_if_1 proto {tcp,udp} to 89.223.65.148 port 80 rdr-to 172.16.0.2 port 80
pass in quick on $ext_if_2 proto {tcp,udp} to 62.152.70.177 port 80 rdr-to 172.16.0.2 port 80
#pass in quick on $ext_if_1 proto {tcp} to 62.152.70.187 port 3081 rdr-to 172.16.17.24 port 3081
#pass in quick on $ext_if_1 proto {tcp} to 62.152.70.187 port 443 rdr-to 172.16.17.24 port 443
#pass in quick on $ext_if_1 proto {tcp,udp} to 62.152.70.187 port 80 rdr-to 127.0.0.1 port 81
#pass in quick on $ext_if_1 proto {tcp,udp} to 62.152.70.187 port 8000 rdr-to 127.0.0.1 port 8000
#pass in quick on $ext_if_1 proto {tcp} to 89.223.65.148 port 80 rdr-to 127.0.0.1 port 82
#pass in quick on $ext_if_1 proto tcp to 62.152.70.187 port 5555 rdr-to 172.16.13.45 port 3189
pass in quick on $ext_if_2 proto tcp to 62.152.70.184 port 995 rdr-to 172.16.0.2 port 110
pass in quick on $ext_if_1 proto tcp to 89.223.65.148 port 995 rdr-to 172.16.0.2 port 110
pass in quick on $ext_if_1 proto tcp to 89.223.65.148 port 465 rdr-to 172.16.0.7 port 25

pass in quick on $ext_if_2 proto tcp to 62.152.70.181 port 1723 rdr-to 172.16.0.2
pass in quick on $ext_if_2 proto gre to 62.152.70.181 rdr-to 172.16.0.2
pass in quick on $ext_if_1 proto tcp to 89.223.65.148 port 1723 rdr-to 172.16.0.2
pass in quick on $ext_if_1 proto gre to 89.223.65.148 rdr-to 172.16.0.2

#pass in quick on {$dmz_if, $ext_if_1} proto tcp to 62.152.70.181 port 1723 rdr-to 172.16.0.2
#pass in quick on {$dmz_if, $ext_if_1} proto gre to 62.152.70.181 rdr-to 172.16.0.2

# Urpf checking (anti-spoof)
block in quick from urpf-failed

# VPN on external interface
#pass in quick on $ext_if_1 inet proto tcp from any to $ext_if_1 port 1723 \
#     flags S/SA synproxy state (max 10, source-track rule, max-src-nodes 5, \
#     max-src-conn-rate 10/60)
pass in quick on $ext_if_1 inet proto tcp from any to $ext_if_1 port 1723 flags S/SA modulate state
pass out quick on $ext_if_1 inet proto gre from any to any keep state
pass in quick on $ext_if_1 inet proto gre from any to any keep state
pass in quick on $ext_if_2 inet proto tcp from any to $ext_if_2 port 1723 flags S/SA modulate state
pass out quick on $ext_if_2 inet proto gre from any to any keep state
pass in quick on $ext_if_2 inet proto gre from any to any keep state

block in quick on {$ext_if_1} inet proto tcp from {$hackers} to any
block in quick on {$int_if_1} inet proto tcp from 172.16.13.41 to any

# Block internal network on external interface
block drop in quick on $ext_if_1 from $priv_nets to any
block drop out quick on $ext_if_1 from any to $priv_nets
block drop in quick on $ext_if_2 from $priv_nets to any
block drop out quick on $ext_if_2 from any to $priv_nets

# Icmp
pass in inet proto icmp all icmp-type $icmp_types keep state

# DMZ
pass quick on $ext_if_1 inet proto tcp from any to 89.223.65.148 port {ftp,ftp-data,ssh,pop3,smtp,domain,http,443,444,7000} flags S/SA keep state
pass quick on $ext_if_2 inet proto tcp from any to 62.152.70.176/28 port {ftp,ftp-data,ssh,pop3,smtp,domain,http,443,444,7000} flags S/SA keep state
pass quick on $ext_if_1 inet proto udp from any to 89.223.65.148 port {domain,7000,5060} keep state
pass quick on $ext_if_2 inet proto udp from any to 62.152.70.176/28 port {domain,7000,5060} keep state

pass quick on {$dmz_if} from $dmz_if:network to any
pass in quick on {$ext_if_1, $dmz_if} proto { tcp, udp, gre } from any to 89.223.65.148
pass in quick on {$ext_if_2, $dmz_if} proto { tcp, udp, gre } from any to 62.152.70.176/28

# Pass from VPN network to internal network
#pass in quick on ng from 192.168.254.0/24 to 172.16.0.0/24
#pass out quick on ng from 172.16.0.0/24 to 192.168.254.0/24
#pass in quick on ng from 192.168.254.0/24 to 172.17.0.0/24
#pass out quick on ng from 172.17.0.0/24 to 192.168.254.0/24


# Pass out
pass in on {$ext_if_1, ext_if_2} proto tcp to port > 49151 flags S/SA user=0 keep state
pass out proto { udp, icmp, gre } all keep state

# Pass all on internal interfaces
pass in quick on $int_if_1 proto {tcp,udp,gre} from any to any
pass out quick on $int_if_1 proto {tcp,udp,gre} from any to any
pass in quick on $int_if_2 proto {tcp,udp} from any to any
pass out quick on $int_if_2 proto {tcp,udp} from any to any
pass in quick on $int_if_3 proto {tcp,udp,gre,icmp} from any to any
pass out quick on $int_if_3 proto {tcp,udp,gre,icmp} from any to any
#pass in quick on $int_if_4 proto {tcp,udp} from any to any
#pass out quick on $int_if_4 proto {tcp,udp} from any to any
pass in quick on tun0 proto {tcp,udp} from any to any
pass out quick on tun0 proto {tcp,udp} from any to any
pass in quick on tun1 proto {tcp,udp,icmp} from any to any
pass out quick on tun1 proto {tcp,udp,icmp} from any to any
pass in quick on lo0 proto {tcp,udp} from any to any
pass out quick on lo0 proto {tcp,udp} from any to any

