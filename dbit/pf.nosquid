# tcpdump -n -e -ttt -i pflog0
# pfctl -f /etc/pf.conf

# Variable declaration
ext_if_1 = "vlan4"
dmz_if = "vlan3"
int_if_1 = "em1"
int_if_2 = "vlan2"
int_if_3 = "vlan900"
int_if_4 = "vlan66"

table <lan_work> {172.16.0.0/16, 172.17.0.0/16, 192.168.2.0/24, 192.168.3.0/24, 192.168.253.0/24, !172.16.0.1, !172.16.0.5, !172.16.0.8, !172.16.13.1, !172.16.13.2, !172.16.13.5, !172.16.13.6, !172.16.13.46, !172.16.13.63, !172.16.13.71, !172.16.13.74, !172.16.13.253, !172.16.0.3, !172.16.25.0/24, !172.20.0.0/16, !172.16.13.57}
table <domino>   {172.16.0.0/16, !172.16.0.2, !172.16.0.8, !172.16.0.9, !172.16.0.16, !172.16.0.36, !172.16.13.1, !172.16.13.46, !172.17.10.71, !172.17.10.72, !172.17.10.73}

int_network_1="172.16.0.0/16"
#no_squid_net="172.16.13.0/28"
table <no_squid_host> {93.153.243.178, 172.17.13.50, 172.17.13.51}
#no_squid_host="85.192.36.168"
hackers="77.95.225.11"

udp_out = "domain, 87, 123, 33333"

# 1959,1961,1966 cityguide
# 873 rsync
# 2041,2042 mail.ru agent
# 50025,50110 commita

tcp_out = "ssh, http, https, 110, 123, pop3s, pptp, 143, 465, 873, 993, 1366, 1935, 1959, 1961, 1966, 1984, 2041, 2042, 3389, 5190, 5222, 8000, 9080, 9418, 9443, 11024, 33333, 44444, 50022, 50025, 50110, 51020"

icmp_types = "echoreq"

priv_nets = "{ 127.0.0.0/8, 192.168.0.0/24, 172.16.0.0/16, 10.0.0.0/8 }"

wotu="32801:32825, 20014"
wott="3128,8081,8088,53,80,8080,20000:25000,32801,32803,443"

# Pf variable

set loginterface $ext_if_1
set block-policy drop

set limit src-nodes 1000000
set limit states 1000000
set limit frags 100000
set optimization normal

# Ftp-proxy anchor
anchor "ftp-proxy/*"

block in quick on {$ext_if_1} inet proto tcp from {$hackers} to any

# Redirect to FTP proxy
pass in quick on {$int_if_1,$int_if_2} inet proto tcp to port ftp divert-to 127.0.0.1 port 8021

# Rabota.ru for ok-pc1
pass in quick on {$int_if_1,$int_if_2} proto tcp from 172.16.15.19 to 85.192.36.168 port {http} rdr-to 85.192.36.168
pass in quick on {$int_if_1,$int_if_2} proto tcp from 172.16.15.19 to 188.40.56.81 port {http} rdr-to 188.40.56.81
pass in quick on {$int_if_1,$int_if_2} proto tcp from 172.16.15.19 to 85.192.36.169 port {http} rdr-to 85.192.36.169

pass in quick on {$int_if_1,$int_if_2} proto tcp from 172.16.0.0/16 to 172.17.10.84 port {http} rdr-to 172.17.10.84
pass in quick on {$int_if_1,$int_if_2} proto tcp from 172.16.0.0/16 to 172.17.10.82 port {http} rdr-to 172.17.10.82



# Redirect to HTTP proxy
#pass in quick on {$int_if_1,$int_if_2} proto tcp from {<lan_work>} to {!<no_squid_host>} port 80 rdr-to 172.16.0.1 port 3128

#pass in quick on {$int_if_1,$int_if_2} proto tcp from {<lan_work>} to {!$no_squid_host} port 443 rdr-to 172.16.0.1 port 3128
#pass in quick on {$int_if_1,$int_if_2} proto tcp from {<lan_work>} to any port 80 rdr-to 172.16.0.1 port 3128

# Argos
pass out quick on $ext_if_1 proto {tcp,udp} from {<lan_work>} to {212.119.184.142,80.247.184.198,80.247.184.204,80.247.184.200} port {25,110} nat-to 62.152.70.177
pass out quick on $ext_if_1 proto {tcp,udp} from {<lan_work>} to {212.119.162.89,80.247.184.202} port {80} nat-to 62.152.70.177

# Sberbank
pass out quick on $ext_if_1 proto {tcp,udp,gre} from $int_if_1:network to {84.204.56.210,84.204.56.212,84.204.56.213,84.204.34.245} nat-to 62.152.70.177

# S.b. terminals
pass out quick on $ext_if_1 proto {tcp,udp,gre} from $int_if_1:network to {81.3.135.249} nat-to 62.152.70.177

pass out quick on $ext_if_1 proto {tcp,udp,gre} from 172.17.0.0/16 to {81.3.135.249} nat-to 62.152.70.177
pass out quick on $ext_if_1 proto {tcp,udp,gre} from 192.168.0.0/16 to {81.3.135.249} nat-to 62.152.70.177


# Rayffazen
pass out quick on $ext_if_1 proto {tcp,udp} from $int_network_1 to {217.148.214.210} port {25,110} nat-to 62.152.70.177

# VTB
pass out quick on $ext_if_1 proto {tcp,udp} from {<lan_work>} to {81.3.179.6} port { 25,110,1024 } nat-to 62.152.70.177

# Commita
pass out quick on $ext_if_1 proto {tcp,udp,gre} from {<lan_work>} to {213.182.169.11} nat-to 62.152.70.177

# Commita Courier
pass out quick on $ext_if_1 proto {tcp,udp,gre} from {<lan_work>} to {213.182.169.93} nat-to 62.152.70.177

# PFR
pass out quick on $ext_if_1 proto {tcp,udp} from $int_if_1:network to {213.182.169.32} port {40226} nat-to 62.152.70.177

# Tensor
pass out quick on $ext_if_1 proto {tcp} from {<lan_work>} to {91.213.144.130} port {25} nat-to 62.152.70.177
pass out quick on $ext_if_1 proto {tcp} from {<lan_work>} to {91.213.144.131} port {110} nat-to 62.152.70.177

# Nat
#pass out quick on $ext_if_1 proto tcp from 172.16.13.0/24 to any port {!=25} nat-to 62.152.70.188
#pass out quick on $ext_if_1 proto tcp from 172.16.15.0/24 to any port {!=25} nat-to 62.152.70.188


pass out quick on $ext_if_1 proto tcp from 172.20.0.0/16 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.20.0.0/16 to any port {!=25} nat-to 62.152.70.188

pass out quick on $ext_if_1 proto tcp from 172.18.0.0/16 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.18.0.0/16 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto gre from 172.18.0.0/16 to any nat-to 62.152.70.188
pass out quick on $ext_if_1 proto icmp from 172.18.0.0/16 to any nat-to 62.152.70.188


pass out quick on $ext_if_1 proto tcp from 172.16.0.2 to any nat-to 62.152.70.177
pass out quick on $ext_if_1 proto gre from 172.16.0.2 to any nat-to 62.152.70.181


pass out quick on $ext_if_1 proto tcp from 172.16.0.3 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.0.3 to any port {!=25} nat-to 62.152.70.188

pass out quick on $ext_if_1 proto tcp from 172.16.0.5 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.0.5 to any port {!=25} nat-to 62.152.70.188

pass out quick on $ext_if_1 proto tcp from 172.16.0.36 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.0.36 to any port {!=25} nat-to 62.152.70.188

pass out quick on $ext_if_1 proto tcp from 172.16.13.1 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.13.1 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto icmp from 172.16.13.1 to any  nat-to 62.152.70.188
pass out quick on $ext_if_1 proto gre from 172.16.13.1 to any  nat-to 62.152.70.188

pass out quick on $ext_if_1 proto tcp from 172.16.13.46 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.13.46 to any port {!=25} nat-to 62.152.70.188

pass out quick on $ext_if_1 proto tcp from 172.16.13.71 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.13.71 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto icmp from 172.16.13.71 to any  nat-to 62.152.70.188
pass out quick on $ext_if_1 proto gre from 172.16.13.71 to any  nat-to 62.152.70.188

pass out quick on $ext_if_1 proto tcp from 172.16.0.8 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.0.8 to any port {!=25} nat-to 62.152.70.188

pass out quick on $ext_if_1 proto tcp from 172.16.15.17 to any port {27014:27050} nat-to 62.152.70.186
pass out quick on $ext_if_1 proto udp from 172.16.15.17 to any port {27000:27030} nat-to 62.152.70.186

pass out quick on $ext_if_1 proto tcp from 172.16.15.27 to any nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.15.27 to any nat-to 62.152.70.188

pass out quick on $ext_if_1 proto tcp from 172.16.13.2 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.13.2 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto icmp from 172.16.13.2 to any nat-to 62.152.70.188

pass out quick on $ext_if_1 proto tcp from 172.16.13.74 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.13.74 to any port {!=25} nat-to 62.152.70.188

pass out quick on $ext_if_1 proto tcp from 172.16.13.45 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.13.45 to any port {!=25} nat-to 62.152.70.188

pass out quick on $ext_if_1 proto tcp from 172.16.13.5 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.13.5 to any port {!=25} nat-to 62.152.70.188

pass out quick on $ext_if_1 proto tcp from 172.16.13.6 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.13.6 to any port {!=25} nat-to 62.152.70.188

#pass out quick on $ext_if_1 proto udp from 172.16.13.8 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.13.46 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.13.57 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto tcp from 172.16.13.57 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.13.58 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto tcp from 172.16.13.58 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.13.60 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto tcp from 172.16.13.60 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.13.61 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto tcp from 172.16.13.61 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.13.67 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto tcp from 172.16.13.67 to any port {!=25} nat-to 62.152.70.188

pass out quick on $ext_if_1 proto udp from 172.16.13.71 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto tcp from 172.16.13.71 to any port {!=25} nat-to 62.152.70.188

pass out quick on $ext_if_1 proto udp from 172.16.13.111 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto tcp from 172.16.13.111 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto tcp from 172.16.13.111 to any nat-to 62.152.70.188

#temporary for mac SA
pass out quick on $ext_if_1 proto udp from 172.16.13.112 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto tcp from 172.16.13.112 to any port {!=25} nat-to 62.152.70.188


pass out quick on $ext_if_1 proto udp from 172.16.15.12 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto tcp from 172.16.15.12 to any port {!=25} nat-to 62.152.70.188

pass out quick on $ext_if_1 proto udp from 172.16.15.60 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto tcp from 172.16.15.60 to any port {!=25} nat-to 62.152.70.188


pass out quick on $ext_if_1 proto tcp from 172.16.13.253 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.13.253 to any port {!=25} nat-to 62.152.70.188

pass out quick on $ext_if_1 proto tcp from 172.16.13.248 to any nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.13.248 to any nat-to 62.152.70.188

#pass out quick on $ext_if_1 proto tcp from 172.16.25.0/24 to any nat-to 62.152.70.188
#pass out quick on $ext_if_1 proto udp from 172.16.25.0/24 to any nat-to 62.152.70.188


#ohrana
pass out quick on $ext_if_1 proto udp from 172.16.13.63 to any port {!=25} nat-to 62.152.70.182
pass out quick on $ext_if_1 proto tcp from 172.16.13.63 to any port {!=25} nat-to 62.152.70.182
pass out quick on $ext_if_1 proto icmp from 172.16.13.63 to any nat-to 62.152.70.182
#
pass out quick on $ext_if_1 proto tcp from 172.16.15.71 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto tcp from 172.17.0.0/16 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto tcp from 172.16.0.30 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto tcp from 172.16.0.55 to any port {!=25} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto tcp from {<lan_work>} to any port {$tcp_out} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from {<lan_work>} to any port {$udp_out} nat-to 62.152.70.188

pass out quick on $ext_if_1 proto tcp from 172.16.15.27 to any port {$wott} nat-to 62.152.70.188
pass out quick on $ext_if_1 proto udp from 172.16.15.27 to any port {$wotu} nat-to 62.152.70.188

#Vlan66-to-lan block
block in quick on $int_if_4 proto {tcp,udp,icmp} from {<domino>} to any
block out quick on $int_if_4 proto {tcp,udp,icmp} from {<domino>} to any

# Redirect to intranet
#pass in quick on $ext_if_1 proto {tcp,udp} to 62.152.70.180 port 8083 rdr-to 172.16.0.23 port 8083
pass in quick on $ext_if_1 proto {tcp,udp} to 62.152.70.180 port 2222 rdr-to 172.16.13.1 port 3389
#pass in quick on $ext_if_1 proto {tcp,udp} to 62.152.70.186 port 3389 rdr-to 172.16.0.23 port 3389
#pass in quick on $ext_if_1 proto {tcp,udp} to 62.152.70.186 port 22 rdr-to 172.16.0.21 port 22
#pass in quick on $ext_if_1 proto {tcp,udp} to 62.152.70.183 port 3389 rdr-to 172.17.0.8 port 3389
#pass in quick on $ext_if_1 proto {tcp,udp} to 62.152.70.182 port ssh rdr-to 172.16.0.33 port ssh
#pass in quick on $ext_if_1 proto {tcp,udp} to 62.152.70.182 port 3389 rdr-to 172.16.15.58 port 3389
#pass in quick on $ext_if_1 proto {tcp,udp} to 62.152.70.183 port ssh rdr-to 172.16.0.21 port ssh
pass in quick on $ext_if_1 proto {tcp,udp} to 62.152.70.177 port 80 rdr-to 172.16.0.2 port 80
pass in quick on $ext_if_1 proto {tcp,udp} to 62.152.70.177 port 55555 rdr-to 172.16.13.1 port 55555
pass in quick on $ext_if_1 proto tcp to 62.152.70.177 port 5555 rdr-to 172.16.13.1 port 3389
pass in quick on $ext_if_1 proto tcp to 62.152.70.177 port 2222 rdr-to 172.16.13.5 port 3389
pass in quick on $ext_if_1 proto {tcp} to 62.152.70.187 port 3080 rdr-to 172.16.17.24 port 3080
pass in quick on $ext_if_1 proto {tcp} to 62.152.70.187 port 3081 rdr-to 172.16.17.24 port 3081
pass in quick on $ext_if_1 proto {tcp} to 62.152.70.187 port 443 rdr-to 172.16.17.24 port 443
pass in quick on $ext_if_1 proto {tcp,udp} to 62.152.70.187 port 80 rdr-to 127.0.0.1 port 81
pass in quick on $ext_if_1 proto {tcp,udp} to 62.152.70.187 port 8000 rdr-to 127.0.0.1 port 8000
pass in quick on $ext_if_1 proto {tcp} to 62.152.70.184 port 80 rdr-to 127.0.0.1 port 82
#pass in quick on $ext_if_1 proto {tcp} to 62.152.70.184 port 80 rdr-to 172.16.0.16 port 80
pass in quick on $ext_if_1 proto tcp to 62.152.70.187 port 5555 rdr-to 172.16.13.45 port 3189

#pass in quick on $ext_if_1 proto udp to 62.152.70.177 port 5060 rdr-to 172.16.0.36 port 5060
#pass in quick on $ext_if_1 proto udp to 62.152.70.177 port 10000:20000 rdr-to 172.16.0.36

pass in quick on $ext_if_1 proto tcp to 62.152.70.181 port 1723 rdr-to 172.16.0.2
pass in quick on $ext_if_1 proto gre to 62.152.70.181 rdr-to 172.16.0.2

pass in quick on $ext_if_1 proto udp to 62.152.70.186 port 27000:27050 rdr-to 172.16.15.17

# Urpf checking (anti-spoof)
block in quick from urpf-failed

# VPN on external interface
#pass in quick on $ext_if_1 inet proto tcp from any to $ext_if_1 port 1723 \
#     flags S/SA synproxy state (max 10, source-track rule, max-src-nodes 5, \
#     max-src-conn-rate 10/60)
pass in quick on $ext_if_1 inet proto tcp from any to $ext_if_1 port 1723 flags S/SA modulate state
pass out quick on $ext_if_1 inet proto gre from any to any keep state
pass in quick on $ext_if_1 inet proto gre from any to any keep state

# Block internal network on external interface
block drop in quick on $ext_if_1 from $priv_nets to any
block drop out quick on $ext_if_1 from any to $priv_nets

# Icmp
pass in inet proto icmp all icmp-type $icmp_types keep state

# DMZ
pass quick on $ext_if_1 inet proto tcp from any to 62.152.70.176/28 port {ftp,ftp-data,ssh,pop3,smtp,domain,http,443,444,7000} flags S/SA keep state
pass quick on $ext_if_1 inet proto udp from any to 62.152.70.176/28 port {domain,7000,5060} keep state
pass quick on {$dmz_if} from $dmz_if:network to any
pass in quick on {$ext_if_1, $dmz_if} proto { tcp, udp, gre } from any to 62.152.70.181
pass in quick on {$ext_if_1, $dmz_if} proto { tcp, udp, gre } from any to 62.152.70.184
pass in quick on {$ext_if_1, $dmz_if} proto { tcp, udp, gre } from any to 62.152.70.188

# Pass from VPN network to internal network
#pass in quick on ng from 192.168.254.0/24 to 172.16.0.0/24
#pass out quick on ng from 172.16.0.0/24 to 192.168.254.0/24
#pass in quick on ng from 192.168.254.0/24 to 172.17.0.0/24
#pass out quick on ng from 172.17.0.0/24 to 192.168.254.0/24


# Pass out
pass in on $ext_if_1 proto tcp to port > 49151 flags S/SA user=0 keep state
pass out proto { udp, icmp, gre } all keep state

# Pass all on internal interfaces
pass in quick on $int_if_1 proto {tcp,udp,gre} from any to any
pass out quick on $int_if_1 proto {tcp,udp,gre} from any to any
pass in quick on $int_if_2 proto {tcp,udp} from any to any
pass out quick on $int_if_2 proto {tcp,udp} from any to any
pass in quick on $int_if_3 proto {tcp,udp,gre,icmp} from any to any
pass out quick on $int_if_3 proto {tcp,udp,gre,icmp} from any to any
#pass in quick on $int_if_4 proto {tcp,udp} from any to any
#pass out quick on $int_if_4 proto {tcp,udp} from any to any
pass in quick on tun0 proto {tcp,udp} from any to any
pass out quick on tun0 proto {tcp,udp} from any to any
pass in quick on tun1 proto {tcp,udp,icmp} from any to any
pass out quick on tun1 proto {tcp,udp,icmp} from any to any
pass in quick on lo0 proto {tcp,udp} from any to any
pass out quick on lo0 proto {tcp,udp} from any to any

